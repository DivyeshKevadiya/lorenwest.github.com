<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns:yui="http://yuilibrary.com/rdf/1.0/yui.rdf#">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<title>monitor   monitor.js </title>

	<link rel="stylesheet" type="text/css" href="assets/reset-fonts-grids-min.css?stamp=1320681730.56" />
	<link rel="stylesheet" type="text/css" href="assets/api.css?stamp=1320681730.56" />

    <script type="text/javascript" src="assets/api-js?stamp=1320681730.56"></script>
    <script type="text/javascript" src="assets/ac-js?stamp=1320681730.56"></script>
</head>

<body id="node-monitor">

<div id="doc3" class="yui-t2">
	<div id="hd">
        <h1><a href="https://github.com/lorenwest/node-monitor" title="Node.js Monitor">Node.js Monitor</a></h1>
        <a href="./index.html" title="Node.js Monitor">Node.js Monitor</a>
            &gt; <a href="./module_monitor.html" title="monitor">monitor</a>
                
                 &gt; monitor.js (source view) 
        <form onsubmit="return false">
            <div id="propertysearch">
                Search: <input autocomplete="off" id="searchinput" />
                <div id="searchresults">
                    &nbsp;
                </div>
            </div>
        </form>
	</div>

	<div id="bd">
		<div id="yui-main">
			<div class="yui-b">
            <form action="#" name="yui-classopts-form" method="get" id="yui-classopts-form">
                <fieldset>
                    <legend>Filters</legend>
                <span class="classopts" id="showPrivate" style="display:none;" ><input type="checkbox" name="show_private" id="show_private" /> <label for="show_private">Show Private</label></span>
                <span class="classopts" id="showProtected" style="display:none;" ><input type="checkbox" name="show_protected" id="show_protected" /> <label for="show_protected">Show Protected</label></span>
                <span class="classopts" id="showDeprecated" style="display:none;" ><input type="checkbox" name="show_deprecated" id="show_deprecated" /> <label for="show_deprecated">Show Deprecated</label></span>
                </fieldset>
            </form>

                    <div id="srcout">
                        <style>
                            #doc3 .classopts { display:none; }
                        </style>
<div class="highlight"><pre><span class="c1">// Dependencies</span>
<span class="kd">var</span> <span class="nx">CONFIG</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">),</span>
    <span class="nx">Connect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">),</span>
    <span class="nx">Log4js</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;log4js&#39;</span><span class="p">);</span>

<span class="c1">// Static members</span>
<span class="kd">var</span> <span class="nx">classRegistry</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">probeRegistry</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">applicationName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">log</span> <span class="o">=</span> <span class="nx">Log4js</span><span class="p">.</span><span class="nx">getLogger</span><span class="p">(</span><span class="s1">&#39;node-monitor&#39;</span><span class="p">),</span>
    <span class="nx">monitorPort</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">isMonitoring</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">monitorServer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="c1">// Set node-monitor configuration defaults</span>
<span class="nx">CONFIG</span><span class="p">.</span><span class="nx">setModuleDefaults</span><span class="p">(</span><span class="s2">&quot;nodeMonitor&quot;</span><span class="p">,</span> <span class="p">{</span>

  <span class="nx">uiPort</span><span class="o">:</span> <span class="mi">4200</span><span class="p">,</span>
  <span class="nx">uiRetryTimer</span><span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>
  <span class="nx">serviceBasePort</span><span class="o">:</span> <span class="mi">42000</span>

<span class="p">});</span>

<span class="c1">// These depend on the above defaults</span>
<span class="nx">MonitorUI</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../ui/server/server.js&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * To get started, place the following in your application bootstrap:</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   var Monitor = require(&#39;monitor&#39;);</span>
<span class="cm"> *   Monitor.start(&#39;My Application&#39;);</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This starts the default monitors and allows the UI to attach to this process.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;To start the UI in this process:&lt;/p&gt;</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   Monitor.startUI();</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;To start the UI in a separate process:&lt;/p&gt;</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> * npm monitor start</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;Then point your browser to port 4200&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @module monitor</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This is the singleton class loaded on require(&#39;monitor&#39;), and is the primary</span>
<span class="cm"> * interface between node-monitor and the running application.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * It offers probe registration so a UI can discover existing probes and</span>
<span class="cm"> * instantiate new ones.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;To monitor an application:&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   var Monitor = require(&#39;monitor&#39;);</span>
<span class="cm"> *   Monitor.start(&#39;My Application&#39;);</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This starts the default probes and allows the UI to attach to this process.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @class Monitor</span>
<span class="cm"> * @constructor</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">Monitor</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Register a probe class.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This generates an ID for, and stores information about the class.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Probe classes and instances are registered so they can be discovered and</span>
<span class="cm"> * instantiated from within a UI.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method registerClass</span>
<span class="cm"> * @param {Function} constructor - Probe constructor function.</span>
<span class="cm"> * @param {Object} classDefinition - Probe class definition.  Fields:</span>
<span class="cm"> *   name {String} - Class name.</span>
<span class="cm"> *   description {String} - Description of the probe type, shown on a UI.</span>
<span class="cm"> *   defaultParameters {Object} - Default probe configurations</span>
<span class="cm"> *   parameterDescriptions {Object} - Descriptions for each configuration element</span>
<span class="cm"> * @returns {Integer} classId - Numeric ID for the probe class.  Used for registering probe instances.</span>
<span class="cm"> *   also adds the classId as an id element of the supplied classDefinition object</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">registerClass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constructor</span><span class="p">,</span> <span class="nx">classDefinition</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Add to the registry &amp; return the class ID</span>
  <span class="kd">var</span> <span class="nx">classId</span> <span class="o">=</span> <span class="nx">classDefinition</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">classRegistry</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="nx">classRegistry</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">constructor</span><span class="o">:</span><span class="nx">constructor</span><span class="p">,</span> <span class="nx">classDefinition</span><span class="o">:</span><span class="nx">classDefinition</span><span class="p">});</span>
  <span class="k">return</span> <span class="nx">classId</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get a probe class definition by ID.</span>
<span class="cm"> *</span>
<span class="cm"> * This returns a copy of the class definition for the specified class ID.</span>
<span class="cm"> *</span>
<span class="cm"> * @method getClassDefinition</span>
<span class="cm"> * @param {Number} classId - The class ID.</span>
<span class="cm"> * @returns {Object} classDefinition - The class definition object for the class ID.</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">getClassDefinition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">classId</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Return a copy of the class definition</span>
  <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">classRegistry</span><span class="p">[</span><span class="nx">classId</span><span class="p">].</span><span class="nx">classDefinition</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get all registered probe class definitions.</span>
<span class="cm"> *</span>
<span class="cm"> * This returns an array of class definitions.  The index to each element in the</span>
<span class="cm"> * array is the class ID.</span>
<span class="cm"> *</span>
<span class="cm"> * @method getClassDefinitions</span>
<span class="cm"> * @returns {Array[Object]} classDefinitions - An array of all class definition objects.</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">getClassDefinitions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">classDefinitions</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">classRegistry</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">classDefinitions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Monitor</span><span class="p">.</span><span class="nx">getClassDefinition</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">classDefinitions</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get a probe class constructor by ID</span>
<span class="cm"> *</span>
<span class="cm"> * @method getClassConstructor</span>
<span class="cm"> * @param {Number} classId - The class ID.</span>
<span class="cm"> * @returns {Function} constructor - The probe class constructor.</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">getClassConstructor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">classId</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">classRegistry</span><span class="p">[</span><span class="nx">classId</span><span class="p">].</span><span class="nx">constructor</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register a probe instance, and retrieve an ID for the instance.</span>
<span class="cm"> *</span>
<span class="cm"> * Probes are registered so they can receive an ID to attach to their monitor</span>
<span class="cm"> * events.  The ID can be back-referenced to the probe class and instance that</span>
<span class="cm"> * generated the event.</span>
<span class="cm"> *</span>
<span class="cm"> * There is no un-register, which has the benefit of retaining information about</span>
<span class="cm"> * events for the duration of the applicaiton.  The drawback is a reference</span>
<span class="cm"> * to the probe is long-held and never garbage collected.  Keep this in mind</span>
<span class="cm"> * when designing probes.</span>
<span class="cm"> *</span>
<span class="cm"> * @method registerProbe</span>
<span class="cm"> * @param {Probe} probeInstance - Instance of the probe class being registered.</span>
<span class="cm"> * @returns {Integer} probeId - Numeric ID for the probe instance.  Used in monitor events.</span>
<span class="cm"> *   Also adds the probeId as an id element in the probeInstance</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">registerProbe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">probeInstance</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Precondition</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">probeInstance</span> <span class="k">instanceof</span> <span class="nx">Probe</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;registerProbe() only accepts derivations of the probe base class&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Start the probe after registration.  This allows probes to send monitor</span>
  <span class="c1">// events in their start() function (because they&#39;ll have the probe ID)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isMonitoring</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">probeInstance</span><span class="p">.</span><span class="nx">start</span><span class="p">();});</span>
  <span class="p">}</span>

  <span class="c1">// Add to the registry &amp; return the probe ID</span>
  <span class="kd">var</span> <span class="nx">probeId</span> <span class="o">=</span> <span class="nx">probeInstance</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">probeRegistry</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="nx">probeRegistry</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">probeInstance</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">probeId</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get the probe definition by ID.</span>
<span class="cm"> *</span>
<span class="cm"> * This returns the name, class, and configuration parameters for the</span>
<span class="cm"> * specified probe.</span>
<span class="cm"> *</span>
<span class="cm"> * @method getProbeDefinition</span>
<span class="cm"> * @param {Number} probeId - The probe ID.</span>
<span class="cm"> * @returns {Object} probeDefinition - An object representing the probe.</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">getProbeDefinition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">probeId</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Build the monitor definition</span>
  <span class="kd">var</span> <span class="nx">probe</span> <span class="o">=</span> <span class="nx">probeRegistry</span><span class="p">[</span><span class="nx">probeId</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">probeDefinition</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">id</span><span class="o">:</span> <span class="nx">probeId</span><span class="p">,</span>
    <span class="nx">name</span><span class="o">:</span> <span class="nx">probe</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="nx">classId</span><span class="o">:</span> <span class="nx">probe</span><span class="p">.</span><span class="nx">classId</span><span class="p">,</span>
    <span class="nx">isRunning</span><span class="o">:</span> <span class="nx">probe</span><span class="p">.</span><span class="nx">isRunning</span><span class="p">,</span>
    <span class="nx">config</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">probe</span><span class="p">.</span><span class="nx">config</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">probeDefinition</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get all registered probe definitions.</span>
<span class="cm"> *</span>
<span class="cm"> * This returns an array of probe definitions.  The index to each element in</span>
<span class="cm"> * the array is the probe ID.</span>
<span class="cm"> *</span>
<span class="cm"> * @method getProbeDefinitions</span>
<span class="cm"> * @returns {Array[ProbeDefinition]} probeDefinitions - An array of probe definitions.</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">getProbeDefinitions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">probeDefinitions</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">probeRegistry</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">probeDefinitions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Monitor</span><span class="p">.</span><span class="nx">getProbeDefinition</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">probeDefinitions</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get the probe instance by ID.</span>
<span class="cm"> *</span>
<span class="cm"> * @method getProbe</span>
<span class="cm"> * @param {Number} probeId - The probe ID.</span>
<span class="cm"> * @returns {Probe} probeInstance - The probe instance</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">getProbe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">probeId</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">probeRegistry</span><span class="p">[</span><span class="nx">probeId</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Start monitoring the application.</span>
<span class="cm"> *</span>
<span class="cm"> * This method sends the start message to all registered probes, notifying them</span>
<span class="cm"> * to obtain necessary resources, and start emitting &lt;i&gt;monitor&lt;/i&gt; events.</span>
<span class="cm"> *</span>
<span class="cm"> * @method start</span>
<span class="cm"> * @param {String} appName - Name of the running application</span>
<span class="cm"> * @param {Function} callback(error) - (optional) Called when the monitor interface has started</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">appName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Already monitoring?</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isMonitoring</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Start up the monitor interface</span>
  <span class="nx">applicationName</span> <span class="o">=</span> <span class="nx">appName</span><span class="p">;</span>
  <span class="nx">startMonitorInterface</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Forward errors</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Start all monitors in parallel</span>
    <span class="nx">isMonitoring</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">numProbes</span> <span class="o">=</span> <span class="nx">probeRegistry</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">probeRegistry</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">probe</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Don&#39;t fail them all if one is bad</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">probe</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="nx">numProbes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Monitor start failure&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Stop monitoring the application.</span>
<span class="cm"> *</span>
<span class="cm"> * This sends the stop message to all registered probes, notifying them</span>
<span class="cm"> * to release resources and stop emitting &lt;i&gt;monitor&lt;/i&gt; events.</span>
<span class="cm"> *</span>
<span class="cm"> * @method stop</span>
<span class="cm"> * @param {Function} callback(error) - (optional) Called when the monitor interface has stopped</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// Already stopped?</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isMonitoring</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Stop the monitor interface</span>
  <span class="nx">stopMonitorInterface</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Forward errors</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Stop all probes in parallel</span>
    <span class="nx">isMonitoring</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">numProbes</span> <span class="o">=</span> <span class="nx">probeRegistry</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">probeRegistry</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">probe</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Don&#39;t fail them all if one is bad</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">probe</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="nx">numProbes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Monitor stop failure&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">* Start the monitor REST interface</span>
<span class="cm">*</span>
<span class="cm">* This opens an interface on the first available port starting at the configured</span>
<span class="cm">* service base port.</span>
<span class="cm">*</span>
<span class="cm">* @method startMonitorInterface</span>
<span class="cm">* @private</span>
<span class="cm">* @param {Function} callback(error) - Called when the interface has started.</span>
<span class="cm">*/</span>
<span class="nx">startMonitorInterface</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Create a middleware stack and routes for baseline REST services</span>
  <span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">Connect</span><span class="p">.</span><span class="nx">createServer</span><span class="p">();</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;/monitor&quot;</span><span class="p">,</span> <span class="nx">Process</span><span class="p">);</span>

  <span class="c1">// Start up the server</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">monitorPort</span><span class="p">)</span> <span class="nx">monitorPort</span> <span class="o">=</span> <span class="nx">CONFIG</span><span class="p">.</span><span class="nx">nodeMonitor</span><span class="p">.</span><span class="nx">serviceBasePort</span><span class="p">;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">monitorPort</span><span class="p">);</span>
    <span class="nx">monitorServer</span> <span class="o">=</span> <span class="nx">server</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Someone else has this port.  Keep trying.</span>
    <span class="nx">monitorPort</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">startMonitorInterface</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Callback if anyone cares</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">* Stop the monitor REST interface</span>
<span class="cm">*</span>
<span class="cm">* @method stopMonitorInterface</span>
<span class="cm">* @private</span>
<span class="cm">* @param {Function} callback(error) - Called when the interface has stopped.</span>
<span class="cm">*/</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">stopMonitorInterface</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Stop the monitor interface</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">monitorServer</span><span class="p">)</span> <span class="nx">monitorServer</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="nx">monitorServer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">monitorPort</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="c1">// Callback if anyone cares</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Start the monitor UI in this process.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This starts the monitor HTTP server listening on the specified port (4200 by default);</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method startUI</span>
<span class="cm"> * @param {Integer} port Override the port specified in the configuration.</span>
<span class="cm"> * @param {Function} callback(error) - (optional) Called when the monitor UI has started.</span>
<span class="cm"> *    Warning: The callback may never be called, or may be called at a far future time if</span>
<span class="cm"> *    another process is listening on this port.</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">startUI</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">MonitorUI</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Stop the monitor UI in this process.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This stops listening (or attempting to listen) for UI events.  It must be called</span>
<span class="cm"> * after startUI.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method stopUI</span>
<span class="cm"> * @param {Function} callback(error) - (optional) Called when the monitor UI has stopped.</span>
<span class="cm"> */</span>
<span class="nx">Monitor</span><span class="p">.</span><span class="nx">stopUI</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">MonitorUI</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// Load these probe classes to make them available</span>
<span class="kd">var</span> <span class="nx">Probe</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./probe&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Process</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./process&#39;</span><span class="p">);</span>
</pre></div>
                    </div>
			</div>
		</div>
		<div class="yui-b">
            <div class="nav">

                    <div id="moduleList" class="module">
                        <h4>Modules</h4>
                        <ul class="content">
                                <li class="selected"><a href="module_monitor.html" title="monitor">monitor</a></li>
                        </ul>
                    </div>

                    <div id="classList" class="module">
                        <h4>Classes</h4>
                        <ul class="content">
                                <li class=""><a href="Monitor.html" title="Monitor">Monitor</a></li>
                                <li class=""><a href="MonitorEvent.html" title="MonitorEvent">MonitorEvent</a></li>
                                <li class=""><a href="Probe.html" title="Probe">Probe</a></li>
                                <li class=""><a href="Process.html" title="Process">Process</a></li>
                        </ul>
                    </div>

                    <div id="fileList" class="module">
                        <h4>Files</h4>
                        <ul class="content">
                                <li class=""><a href="monitor-event.js.html" title="monitor-event.js">monitor-event.js</a></li>
                                <li class="selected"><a href="monitor.js.html" title="monitor.js">monitor.js</a></li>
                                <li class=""><a href="probe.js.html" title="probe.js">probe.js</a></li>
                                <li class=""><a href="process.js.html" title="process.js">process.js</a></li>
                        </ul>
                    </div>





            </div>
		</div>
	</div>
	<div id="ft">
        <hr />
Released on <a href="https://github.com/lorenwest/node-monitor">github</a> under the <a href="https://github.com/lorenwest/node-monitor/blob/master/LICENSE">Apache License 2.0</a>
<span class="subtitle">version 0.4.0</span>
	</div>
</div>
<script type="text/javascript">
    ALL_YUI_PROPS = [{"url": "Probe.html#method_emitMonitorEvent", "access": "", "host": "Probe", "type": "method", "name": "emitMonitorEvent"}, {"url": "Monitor.html#method_getClassConstructor", "access": "", "host": "Monitor", "type": "method", "name": "getClassConstructor"}, {"url": "Monitor.html#method_getClassDefinition", "access": "", "host": "Monitor", "type": "method", "name": "getClassDefinition"}, {"url": "Monitor.html#method_getClassDefinitions", "access": "", "host": "Monitor", "type": "method", "name": "getClassDefinitions"}, {"url": "Monitor.html#method_getProbe", "access": "", "host": "Monitor", "type": "method", "name": "getProbe"}, {"url": "Monitor.html#method_getProbeDefinition", "access": "", "host": "Monitor", "type": "method", "name": "getProbeDefinition"}, {"url": "Monitor.html#method_getProbeDefinitions", "access": "", "host": "Monitor", "type": "method", "name": "getProbeDefinitions"}, {"url": "Probe.html#event_monitor", "access": "", "host": "Probe", "type": "event", "name": "monitor"}, {"url": "Monitor.html#method_registerClass", "access": "", "host": "Monitor", "type": "method", "name": "registerClass"}, {"url": "Monitor.html#method_registerProbe", "access": "", "host": "Monitor", "type": "method", "name": "registerProbe"}, {"url": "Monitor.html#method_start", "access": "", "host": "Monitor", "type": "method", "name": "start"}, {"url": "Probe.html#method_start", "access": "", "host": "Probe", "type": "method", "name": "start"}, {"url": "Probe.html#event_start", "access": "", "host": "Probe", "type": "event", "name": "start"}, {"url": "Process.html#method_start", "access": "", "host": "Process", "type": "method", "name": "start"}, {"url": "Monitor.html#method_startUI", "access": "", "host": "Monitor", "type": "method", "name": "startUI"}, {"url": "Monitor.html#method_stop", "access": "", "host": "Monitor", "type": "method", "name": "stop"}, {"url": "Probe.html#method_stop", "access": "", "host": "Probe", "type": "method", "name": "stop"}, {"url": "Probe.html#event_stop", "access": "", "host": "Probe", "type": "event", "name": "stop"}, {"url": "Monitor.html#method_stopUI", "access": "", "host": "Monitor", "type": "method", "name": "stopUI"}];
</script>
</body>
</html>
